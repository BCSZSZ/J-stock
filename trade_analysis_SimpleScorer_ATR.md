# SimpleScorer + ATRExitStrategy 交易分析

## 问题：总回报 -99.96% (¥5,000,000 → ¥2,032)

## 完整交易记录

| #      | 买入日期       | 买入价     | 股数      | 卖出日期   | 卖出价    | 收益率  | 盈亏金额    | 退出原因       | 剩余资金   |
| ------ | -------------- | ---------- | --------- | ---------- | --------- | ------- | ----------- | -------------- | ---------- |
| 1      | 2023-08-04     | ¥2,407     | 2,077     | 2023-10-02 | ¥2,700.50 | +12.19% | +¥609,600   | P1 Trailing    | ¥5,609,600 |
| 2      | 2023-11-06     | ¥2,840     | 1,975     | 2023-12-11 | ¥2,701    | -4.89%  | -¥274,525   | P0 Hard Stop   | ¥5,335,075 |
| 3      | 2024-01-15     | ¥2,854     | 1,869     | 2024-03-13 | ¥3,506    | +22.85% | +¥1,218,588 | P1 Trailing    | ¥6,553,663 |
| 4      | 2024-04-01     | ¥3,801     | 1,724     | 2024-04-18 | ¥3,567    | -6.16%  | -¥403,416   | P0 Hard Stop   | ¥6,150,247 |
| 5      | 2024-07-05     | ¥3,384     | 1,817     | 2024-07-18 | ¥3,151    | -6.89%  | -¥423,361   | P0 Hard Stop   | ¥5,726,886 |
| 6      | 2025-03-25     | ¥2,916     | 1,963     | 2025-03-31 | ¥2,630.50 | -9.79%  | -¥560,436   | P0 Hard Stop   | ¥5,166,450 |
| 7      | 2025-06-02     | ¥2,737.50  | 1,887     | 2025-06-06 | ¥2,630.50 | -3.91%  | -¥201,909   | P3 Trend Break | ¥4,964,541 |
| 8      | 2025-08-27     | ¥2,903     | 1,710     | 2025-10-03 | ¥2,806    | -3.34%  | -¥165,870   | P1 Trailing    | ¥4,798,671 |
| 9      | 2025-10-08     | ¥3,050     | 1,573     | 2025-10-14 | ¥2,848.50 | -6.61%  | -¥316,960   | P0 Hard Stop   | ¥4,481,711 |
| 10     | 2025-10-16     | ¥2,964     | 1,512     | 2025-12-04 | ¥3,028    | +2.16%  | +¥96,768    | P1 Trailing    | ¥4,578,479 |
| **11** | **2025-12-05** | **¥3,053** | **1,499** | **持仓中** | -         | -       | -           | -              | **¥2,032** |

## 🔍 关键发现

### 问题核心：第 11 笔交易锁死了所有资金！

**2025-12-05 买入：**

- 价格：¥3,053
- 股数：1,499 股
- **总投入：¥4,578,447 (几乎全部剩余资金)**
- **剩余现金：仅 ¥2,032**

**致命问题：**

1. **全仓买入**：用掉了 99.96% 的资金 (¥4,578,447 / ¥4,578,479)
2. **持仓未平**：到 2026-01-08 回测结束时仍然持仓
3. **最终结果**：只剩现金 ¥2,032，因为股票价值未计入最终资金

## 📊 统计分析

### 完成的 10 笔交易表现

- **赢利交易**: 3 次 (30%)

  - 最佳: +22.85% (+¥1,218,588)
  - 平均盈利: +12.40%
  - 总盈利: ¥1,924,956

- **亏损交易**: 7 次 (70%)

  - 最差: -9.79% (-¥560,436)
  - 平均亏损: -5.94%
  - 总亏损: -¥2,346,477

- **净盈亏**: -¥421,521 (完成交易部分)
- **理论资金**: ¥4,578,479 (第 11 笔买入前)

### 问题根源

#### 1. **Position Size 计算错误**

引擎在计算买入股数时，似乎使用了"全部可用资金"：

```python
# 推测的错误逻辑
shares = available_cash / current_price  # 全仓买入！
```

**应该是风险控制的仓位：**

```python
# 正确逻辑应该是
position_size = available_cash * position_size_pct  # 例如20%
shares = position_size / current_price
```

#### 2. **最终资金计算问题**

回测结束时没有按市价平仓或计算持仓价值：

- **实际持仓**: 1,499 股 @ 最新价格
- **应有价值**: 1,499 × (2026-01-08 收盘价)
- **当前计算**: 只统计现金 ¥2,032

#### 3. **退出信号缺失**

从 2025-12-05 到 2026-01-08 (34 天)，ATR Exit 没有生成卖出信号：

- 可能价格一直在止损线之上
- 没有触发任何 P0-P3 退出条件
- 导致持仓到回测结束

## 💡 修复建议

### 优先级 1: 仓位管理 (CRITICAL)

```python
# 在 BacktestEngine 中添加
self.position_size_pct = 0.2  # 每次最多使用20%资金

def calculate_shares(self, available_cash, price):
    position_value = available_cash * self.position_size_pct
    shares = int(position_value / price)
    return shares
```

### 优先级 2: 回测结束时平仓

```python
# 在回测结束时
if current_position:
    final_price = df_features.iloc[-1]['Close']
    final_value = current_position.shares * final_price
    cash += final_value
    logger.info(f"Final position closed at ¥{final_price}")
```

### 优先级 3: 最终资金计算

```python
# 正确计算最终总资产
final_total = cash + (position.shares * current_price if position else 0)
```

## 验证数据

如果第 11 笔交易按 ¥3,053 买入，持仓到 2026-01-08：

- 需要查询 7203 在 2026-01-08 的收盘价
- 假设收盘价 = ¥3,053 (不变)
  - 持仓价值: 1,499 × ¥3,053 = ¥4,576,447
  - 总资产: ¥4,576,447 + ¥2,032 = **¥4,578,479**
  - 总回报: -8.43% (而非 -99.96%)

## 结论

**-99.96% 的亏损是虚假的！**

真实情况：

1. ✅ 前 10 笔交易盈亏: -¥421,521 (-8.4%)
2. ✅ 第 11 笔持仓中: 价值约 ¥4,576,447
3. ❌ 系统错误: 只统计现金 ¥2,032
4. ❌ 仓位管理: 每次全仓买入

**需要修复的代码**：

1. 添加仓位管理 (position_size_pct)
2. 回测结束时平仓或计入持仓价值
3. 修正最终资金计算逻辑
