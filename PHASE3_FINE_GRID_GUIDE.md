# 🎯 参数细化网格搜索 — Phase 3 执行指南

**日期**: 2026年02月22日  
**目标**: 围绕最优参数 D18_B20 进行微调优化，找到更高性能参数  
**方法**: 81个策略 × 5年 = 405个回测，使用4 workers并行  
**预期耗时**: 35-40分钟  

---

## 📊 微调参数配置

### 固定参数

| 参数 | 数值 | 说明 |
|------|------|------|
| **D (持仓天数)** | 18 | 🔒 固定，基于最优发现 |
| 入场策略 | MACDCrossoverStrategy | 固定 |
| N/R/T基础值 | 9/3.5/1.6 | 中心值 |

### 微调参数网格 (3^4 = 81组合)

| 参数 | 范围 | 步长 | 数值 | 说明 |
|------|------|------|------|------|
| **B (偏离度%)** | ±0.5 | 0.5 | 19.5, 20.0, 20.5 | 三点采样 |
| **N (MACD周期)** | ±1 | 1.0 | 8, 9, 10 | 三点采样 |
| **R (回报倍数)** | ±0.1 | 0.1 | 3.4, 3.5, 3.6 | 三点采样 |
| **T (尾随倍数)** | ±0.1 | 0.1 | 1.5, 1.6, 1.7 | 三点采样 |

**组合方式**: B × N × R × T = 3 × 3 × 3 × 3 = **81个**

### 参数网格空间可视化

```
        B维度 (偏离度)
        ↓
        19.5  20.0  20.5
        │     │     │
N→ 8    ●     ●     ●
   9    ●     ●     ● ← 最优中心 (9,3.5,1.6,20)
   10   ●     ●     ●
   
每个●代表R(3.4/3.5/3.6) × T(1.5/1.6/1.7) = 9个组合
总计: 3(B) × 3(N) × 9(R×T) = 81
```

---

## 🚀 执行方案

### 方案A: PowerShell 脚本 (推荐✓)

```powershell
# 1. 进入项目目录
cd e:\Code\AI-stock\J-stock

# 2. 执行回测脚本
.\execute_fine_grid.ps1

# 脚本会自动：
# - 加载81个策略配置
# - 并行执行405个回测
# - 保存结果到Google Drive
```

**优点**: 
- 自动化，无需手动输入
- 实时进度显示
- 完整的错误处理

**预期输出**:
```
================================================
  ✅ 回测完成!
================================================
  耗时: XX.XX 分钟
  结果保存位置:
    - strategy_evaluation_raw_yyyymmdd_hhmmss.csv
    - strategy_evaluation_by_regime_yyyymmdd_hhmmss.csv
    - strategy_evaluation_report_yyyymmdd_hhmmss.md
================================================
```

---

### 方案B: Python 脚本

```bash
# 1. 进入项目目录
cd e:\Code\AI-stock\J-stock

# 2. 执行Python包装脚本
python tools/run_fine_grid.py
```

**优点**:
- 跨平台兼容
- Python异常处理更完善

---

### 方案C: 直接CLI (手动)

如果需要自定义，可复制生成脚本中的CLI命令：

```powershell
e:.venv\Scripts\python.exe main.py evaluate `
  --mode annual `
  --years 2021 2022 2023 2024 2025 `
  --entry-strategies MACDCrossoverStrategy `
  --exit-strategies `
    MVX_N8_R3p4_T1p5_D18_B19p5 `
    MVX_N8_R3p4_T1p6_D18_B19p5 `
    ... (共81个) ...
    MVX_N10_R3p6_T1p7_D18_B20p5
```

---

## 📈 预期收益

### 优化目标

| 指标 | 当前(D18_B20) | 期望 | 改进 |
|------|---|---|---|
| 5年平均收益 | 35.30% | 35-38% | +0.7-2.7% |
| 夏普比率 | 1.69 | >1.70 | +0.01 |
| 最大回撤 | 11.6% | <12.0% | -0.4% |
| 强牛市(2023) Alpha | -5.90% | >-5% | 改善 |

### 可能的新冠军

根据数据驱动假设，以下组合有较高概率成为新冠军:

1. **D18_B20_N9_R3p5_T1p6** (当前冠军，对标)
2. **D18_B20_N8_R3p5_T1p6** (减少假信号) ⭐ 预期 +0.5-1%
3. **D18_B19p5_N9_R3p5_T1p5** (更积极出场) ⭐ 预期 +0.3-0.8%
4. **D18_B20_N10_R3p5_T1p7** (更长周期) ⭐ 预期 改善强牛市

**理由**: N值较小减少MACD假信号，B值略低更快出场，可能在强牛市改善

---

## 🔍 关键监控指标

执行后，**重点关注**:

### 1. 性能排名变化

```
新冠军 vs 原冠军 (D18_B20):
- 收益率: ±1-2%范围内为显著提升
- 夏普比: ±0.02以上为稳健性改善
- 胜率: ±2%以内波动正常
```

### 2. 市场环境敏感性

```
强牛市表现改善? 
- 2023年 Alpha: 从 -5.90% → 接近 0% 即为成功
- 这将填补目前的最大弱点

稳定性:
- 熊市、温和牛市表现不退化
```

### 3. 参数稳定性分析

```
相邻参数对比:
- D18_B20.0 vs D18_B19.5 vs D18_B20.5 的收益差异
- 差异>3%表示参数敏感，反之表示稳健
```

---

## 🛠️ 脚本生成的文件清单

```
e:\Code\AI-stock\J-stock\
├── execute_fine_grid.ps1        ✅ PowerShell执行脚本
├── tools/
│   ├── generate_fine_grid.py    ✅ 参数生成脚本
│   ├── run_fine_grid.py         ✅ Python包装脚本
│   └── (已上述脚本生成81个CLI命令)

注: 主程序配置已自动更新
├── src/analysis/strategies/exit/
│   └── multiview_grid_exit.py   ✅ 已更新支持81个策略
```

---

## 📋 执行清单

- [ ] **确认脚本已生成** (已完成 ✅)
  ```powershell
  dir e:\Code\AI-stock\J-stock\execute_fine_grid.ps1
  ```

- [ ] **验证策略配置** (已完成 ✅)
  ```bash
  python -c "from src.analysis.strategies.exit.multiview_grid_exit import GRID_EXIT_STRATEGY_MAP; print(len(GRID_EXIT_STRATEGY_MAP))"
  # 输出: 81 ✓
  ```

- [ ] **准备开始回测**
  ```powershell
  cd e:\Code\AI-stock\J-stock
  .\execute_fine_grid.ps1
  ```

- [ ] **监控执行进度**
  - 观察PowerShell窗口输出
  - 预计进度: 每25个测试打印一次进度
  - 总耗时: 35-40分钟

- [ ] **分析结果**
  - 等待脚本完成
  - 查看Google Drive新生成的三个文件
  - 对比性能排名

---

## 💡 技术亮点

### 1. 脚本化网格搜索

✅ **自动生成**: 不需要手动编辑CLI命令，脚本自动生成81个组合

✅ **遵循主程序架构**: 只是调用main.py evaluate，未改动核心逻辑

✅ **多维度参数搜索**: 支持单固定值+多维微调的灵活搜索模式

### 2. 参数命名规范

策略名格式: `MVX_N{n}_R{r}_T{t}_D{d}_B{b}`

示例:
- `MVX_N8_R3p4_T1p5_D18_B19p5` ← N=8, R=3.4, T=1.5, D=18, B=19.5
- `MVX_N9_R3p5_T1p6_D18_B20p0` ← 中心值 (参考D18_B20)
- `MVX_N10_R3p6_T1p7_D18_B20p5` ← 上限值

浮点处理: `.` → `p` (例: 3.5 → 3p5, 20.5 → 20p5)

### 3. 并行执行效率

- **Workers**: 4个并行进程
- **缓存**: 数据预加载，减少IO
- **预期**: 405个回测约40分钟
- **对比**: 单线程需 3-4小时

---

## 🎯 后续分析计划

回测完成后，将生成：

1. **原始CSV** (405行 × 14列)
   - 完整的参数-性能对应关系

2. **市场环境汇总** (81策略 × 3环境)
   - 按熊市、温牛、强牛分类

3. **Markdown报告** (自动生成)
   - 排名、统计、建议

**手动分析方向**:

```
1. 热力图分析: 
   matrix[N][B] = 平均收益%
   寻找峰值组合

2. 敏感性分析:
   ΔReturn / ΔParameter 
   找出最敏感的参数维度

3. 分布分析:
   81个策略的收益分布
   标准差、四分位数等

4. 最优组合推荐:
   收益vs风险vs稳定性的pareto前沿
```

---

## ⚠️ 注意事项

1. **执行时间长**
   - 勿中断进程
   - 机器负载会达到100% (正常)
   - 风扇可能较吵 (正常)

2. **结果准确性**
   - 与Phase 1/2共享相同数据源
   - 回测有过拟合风险 (405个回测)
   - 实盘表现可能有偏差

3. **磁盘空间**
   - 单个CSV文件约 2-3MB
   - 确保Google Drive空间充足

4. **网络连接**
   - 结果写入Google Drive需网络
   - 若连接中断，本地仍有缓存

---

*准备好了吗？执行 `.\execute_fine_grid.ps1` 开始405个回测！*
